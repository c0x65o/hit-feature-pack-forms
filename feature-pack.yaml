# Feature Pack: form-core
# Runtime-configurable custom forms (builder + CRUD entries)

name: form-core
title: System Custom Forms
description: Runtime Forms feature pack with builder + CRUD entries + search + reference linking

# Route definitions - mapped to React components
routes:
  # Form management routes - admin only
  - path: /forms
    page: FormList
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: forms, verb: read, require_mode: any }
  - path: /forms/new
    page: FormBuilder
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: forms, verb: write, require_create: true, require_mode: any }
  - path: /forms/[id]
    page: FormBuilder
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: forms, verb: write, require_mode: any }
  # Entry routes - accessible based on form ACLs (checked at runtime)
  - path: /forms/[id]/entries
    page: EntryList
    roles: []
    authz: { entity: entries, verb: read }
  - path: /forms/[id]/entries/new
    page: EntryEdit
    roles: []
    authz: { entity: entries, verb: write, require_create: true }
  - path: /forms/[id]/entries/[entryId]
    page: EntryDetail
    roles: []
    authz: { entity: entries, verb: read }
  - path: /forms/[id]/entries/[entryId]/edit
    page: EntryEdit
    roles: []
    authz: { entity: entries, verb: write }

# Navigation contributions
# Note: Navigation is handled via runtime injection in runtime-forms-nav.ts
# which creates the "Custom Forms" parent with published forms as children.
# No static nav contribution needed here.
nav: []

# Schema contributions (Drizzle tables)
schema:
  source: src/schema/forms.ts
  exports: [forms, formVersions, formFields, formEntries, formEntryHistory, formsAcls, formsPrincipalTypeEnum]

# API routes expected by this pack
# Handlers are exported from the feature pack and imported at runtime
api:
  routes:
    - path: /api/forms
      methods: [GET, POST]
      handler: "@hit/feature-pack-form-core/server/api/forms"
      description: "List forms (GET) or create form (POST)"
    - path: /api/forms/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-form-core/server/api/forms-id"
      description: "Get, update, or delete a form"
    - path: /api/forms/[id]/schema
      methods: [GET]
      handler: "@hit/feature-pack-form-core/server/api/forms-id-schema"
      description: "Get a platform-agnostic schema for a form (fields + configs) for non-React clients"
    - path: /api/forms/[id]/entries
      methods: [GET, POST]
      handler: "@hit/feature-pack-form-core/server/api/entries"
      description: "List entries (GET) or create entry (POST)"
    - path: /api/forms/[id]/entries/[entryId]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-form-core/server/api/entries-id"
      description: "Get, update, or delete an entry"
    - path: /api/forms/[id]/acl
      methods: [GET, POST]
      handler: "@hit/feature-pack-form-core/server/api/acl"
      description: "List ACLs (GET) or create ACL entry (POST) for a form"
    - path: /api/forms/[id]/acl/[aclId]
      methods: [DELETE]
      handler: "@hit/feature-pack-form-core/server/api/acl"
      description: "Delete an ACL entry"
    - path: /api/forms/linked
      methods: [GET]
      handler: "@hit/feature-pack-form-core/server/api/linked"
      description: "List published forms linked to an entity via entity_reference fields (dynamic entity tabs)"

requires:
  modules: []

dependencies:
  feature_packs:
    - name: erp-shell-core

# Configurable options
config:
  schema:
    enable_history:
      type: boolean
      default: true
      description: "Write entry snapshots on update/delete."
    enable_reference_fields:
      type: boolean
      default: true
      description: "Enable reference field type and picker UI."

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Global scope policy for form-core (base layer).
    # This is checked by the scope-mode resolver as a fallback when entity-level overrides are not granted.
    - key: form-core.read.scope.none
      label: "Form-Core Read Scope = None"
      description: "Deny all form-core read access."
      default_enabled: false
    - key: form-core.read.scope.any
      label: "Form-Core Read Scope = Any"
      description: "Read all form-core entities regardless of scope."
      default_enabled: false
    - key: form-core.read.scope.own
      label: "Form-Core Read Scope = Own"
      description: "Read only form-core entities you own."
      default_enabled: false
    - key: form-core.read.scope.ldd
      label: "Form-Core Read Scope = LDD"
      description: "Read form-core entities you own, or that match your L/D/D scope."
      default_enabled: false

    - key: form-core.write.scope.none
      label: "Form-Core Write Scope = None"
      description: "Deny all form-core write access."
      default_enabled: false
    - key: form-core.write.scope.any
      label: "Form-Core Write Scope = Any"
      description: "Edit all form-core entities regardless of scope."
      default_enabled: false
    - key: form-core.write.scope.own
      label: "Form-Core Write Scope = Own"
      description: "Edit only form-core entities you own."
      default_enabled: false
    - key: form-core.write.scope.ldd
      label: "Form-Core Write Scope = LDD"
      description: "Edit form-core entities you own, or that match your L/D/D scope."
      default_enabled: false

    - key: form-core.delete.scope.none
      label: "Form-Core Delete Scope = None"
      description: "Deny all form-core delete access."
      default_enabled: false
    - key: form-core.delete.scope.any
      label: "Form-Core Delete Scope = Any"
      description: "Delete all form-core entities regardless of scope."
      default_enabled: false
    - key: form-core.delete.scope.own
      label: "Form-Core Delete Scope = Own"
      description: "Delete only form-core entities you own."
      default_enabled: false
    - key: form-core.delete.scope.ldd
      label: "Form-Core Delete Scope = LDD"
      description: "Delete form-core entities you own, or that match your L/D/D scope."
      default_enabled: false

    # Forms (form definitions) - admin-only scope
    # Forms are form definitions managed by admins. Scope modes apply to form management.
    - key: form-core.forms.read.scope.none
      label: "Form-Core Forms Read Scope = None"
      description: "Deny all form definition read access."
      default_enabled: false
    - key: form-core.forms.read.scope.any
      label: "Form-Core Forms Read Scope = Any"
      description: "Read all form definitions regardless of ownership."
      default_enabled: false
    - key: form-core.forms.read.scope.own
      label: "Form-Core Forms Read Scope = Own"
      description: "Read only form definitions you own."
      default_enabled: false
    - key: form-core.forms.read.scope.ldd
      label: "Form-Core Forms Read Scope = LDD"
      description: "Read form definitions you own, or that match your L/D/D scope."
      default_enabled: false

    - key: form-core.forms.write.scope.none
      label: "Form-Core Forms Write Scope = None"
      description: "Deny all form definition write access."
      default_enabled: false
    - key: form-core.forms.write.scope.any
      label: "Form-Core Forms Write Scope = Any"
      description: "Edit form definitions regardless of ownership."
      default_enabled: false
    - key: form-core.forms.write.scope.own
      label: "Form-Core Forms Write Scope = Own"
      description: "Edit only form definitions you own."
      default_enabled: false
    - key: form-core.forms.write.scope.ldd
      label: "Form-Core Forms Write Scope = LDD"
      description: "Edit form definitions you own, or that match your L/D/D scope."
      default_enabled: false

    - key: form-core.forms.delete.scope.none
      label: "Form-Core Forms Delete Scope = None"
      description: "Deny all form definition delete access."
      default_enabled: false
    - key: form-core.forms.delete.scope.any
      label: "Form-Core Forms Delete Scope = Any"
      description: "Delete form definitions regardless of ownership."
      default_enabled: false
    - key: form-core.forms.delete.scope.own
      label: "Form-Core Forms Delete Scope = Own"
      description: "Delete only form definitions you own."
      default_enabled: false
    - key: form-core.forms.delete.scope.ldd
      label: "Form-Core Forms Delete Scope = LDD"
      description: "Delete form definitions you own, or that match your L/D/D scope."
      default_enabled: false

    - key: form-core.forms.create
      label: Create Form
      description: "Create a new form definition."
      default_enabled: false

    # Form Entries - ACL-aware scope
    # Form entries use ACLs for fine-grained access control, but scope modes provide
    # a base layer of access control. Entries are scoped by form ownership and LDD.
    # Note: Entry-level ACLs (via formsAcls) still apply in addition to scope modes.
    - key: form-core.entries.read.scope.none
      label: "Form-Core Entries Read Scope = None"
      description: "Deny all form entry read access."
      default_enabled: false
    - key: form-core.entries.read.scope.any
      label: "Form-Core Entries Read Scope = Any"
      description: "Read all form entries regardless of form ownership/LDD (subject to form ACLs)."
      default_enabled: false
    - key: form-core.entries.read.scope.own
      label: "Form-Core Entries Read Scope = Own"
      description: "Read only form entries for forms you own (subject to form ACLs)."
      default_enabled: false
    - key: form-core.entries.read.scope.ldd
      label: "Form-Core Entries Read Scope = LDD"
      description: "Read form entries for forms you own or that match your L/D/D scope (subject to form ACLs)."
      default_enabled: false

    - key: form-core.entries.write.scope.none
      label: "Form-Core Entries Write Scope = None"
      description: "Deny all form entry write access."
      default_enabled: false
    - key: form-core.entries.write.scope.any
      label: "Form-Core Entries Write Scope = Any"
      description: "Edit form entries regardless of form ownership/LDD (subject to form ACLs)."
      default_enabled: false
    - key: form-core.entries.write.scope.own
      label: "Form-Core Entries Write Scope = Own"
      description: "Edit only form entries for forms you own (subject to form ACLs)."
      default_enabled: false
    - key: form-core.entries.write.scope.ldd
      label: "Form-Core Entries Write Scope = LDD"
      description: "Edit form entries for forms you own or that match your L/D/D scope (subject to form ACLs)."
      default_enabled: false

    - key: form-core.entries.delete.scope.none
      label: "Form-Core Entries Delete Scope = None"
      description: "Deny all form entry delete access."
      default_enabled: false
    - key: form-core.entries.delete.scope.any
      label: "Form-Core Entries Delete Scope = Any"
      description: "Delete form entries regardless of form ownership/LDD (subject to form ACLs)."
      default_enabled: false
    - key: form-core.entries.delete.scope.own
      label: "Form-Core Entries Delete Scope = Own"
      description: "Delete only form entries for forms you own (subject to form ACLs)."
      default_enabled: false
    - key: form-core.entries.delete.scope.ldd
      label: "Form-Core Entries Delete Scope = LDD"
      description: "Delete form entries for forms you own or that match your L/D/D scope (subject to form ACLs)."
      default_enabled: false

    - key: form-core.entries.create
      label: Create Form Entry
      description: "Create a new form entry (subject to form ACLs)."
      default_enabled: false
